<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified POC</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const API_URL = "http://localhost:8000/api/v1";

        function App() {
            const [token, setToken] = React.useState(localStorage.getItem('token'));
            const [user, setUser] = React.useState(null);

            const logout = () => {
                setToken(null);
                localStorage.removeItem('token');
                setUser(null);
            };

            if (!token) {
                return <Login setToken={setToken} />;
            }

            return (
                <div className="container mx-auto p-4">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold text-gray-800">Unified POC Dashboard</h1>
                        <button onClick={logout} className="text-red-500 hover:text-red-700">Logout</button>
                    </div>
                    <Dashboard token={token} />
                </div>
            );
        }

        function Login({ setToken }) {
            const [isRegister, setIsRegister] = React.useState(false);
            const [email, setEmail] = React.useState("");
            const [password, setPassword] = React.useState("");
            const [error, setError] = React.useState("");

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError("");
                try {
                    const endpoint = isRegister ? "/auth/register" : "/auth/login";
                    const res = await axios.post(`${API_URL}${endpoint}`, { email, password });
                    const token = res.data.access_token;
                    localStorage.setItem('token', token);
                    setToken(token);
                } catch (err) {
                    setError(err.response?.data?.detail || "An error occurred");
                }
            };

            return (
                <div className="flex justify-center items-center h-screen">
                    <div className="bg-white p-8 rounded shadow-md w-96">
                        <h2 className="text-2xl mb-4 font-bold">{isRegister ? "Register" : "Login"}</h2>
                        {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium">Email</label>
                                <input className="w-full border p-2 rounded" type="email" value={email} onChange={e => setEmail(e.target.value)} required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium">Password</label>
                                <input className="w-full border p-2 rounded" type="password" value={password} onChange={e => setPassword(e.target.value)} required />
                            </div>
                            <button className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700" type="submit">
                                {isRegister ? "Register" : "Login"}
                            </button>
                        </form>
                        <button onClick={() => setIsRegister(!isRegister)} className="w-full mt-4 text-sm text-blue-500 hover:underline">
                            {isRegister ? "Already have an account? Login" : "Need an account? Register"}
                        </button>
                    </div>
                </div>
            );
        }

        function Dashboard({ token }) {
            const [activeTab, setActiveTab] = React.useState("github");

            return (
                <div className="bg-white rounded shadow p-6">
                    <div className="flex space-x-4 border-b mb-6">
                        {['github', 'figma', 'trello', 'ai assistant'].map(tab => (
                            <button
                                key={tab}
                                onClick={() => setActiveTab(tab)}
                                className={`pb-2 capitalize ${activeTab === tab ? 'border-b-2 border-blue-500 font-bold' : 'text-gray-500'}`}
                            >
                                {tab}
                            </button>
                        ))}
                    </div>
                    {activeTab === 'github' && <GitHub token={token} />}
                    {activeTab === 'figma' && <Figma token={token} />}
                    {activeTab === 'trello' && <Trello token={token} />}
                    {activeTab === 'ai assistant' && <AIChat token={token} />}
                </div>
            );
        }

        function AIChat({ token }) {
            const [messages, setMessages] = React.useState([]);
            const [input, setInput] = React.useState("");
            const [loading, setLoading] = React.useState(false);

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!input.trim()) return;
                
                const userMsg = { role: "user", content: input };
                const newMessages = [...messages, userMsg];
                setMessages(newMessages);
                setInput("");
                setLoading(true);

                try {
                    const res = await axios.post(`${API_URL}/agent/chat`, { messages: newMessages }, { headers: { Authorization: `Bearer ${token}` } });
                    setMessages([...newMessages, { role: "assistant", content: res.data.response }]);
                } catch (err) {
                    console.error(err);
                    setMessages([...newMessages, { role: "assistant", content: "Error: " + (err.response?.data?.detail || "Failed to get response. Ensure OPENAI_API_KEY is set in backend .env and GitHub is connected.") }]);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex flex-col h-[500px]">
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 border rounded mb-4 bg-gray-50">
                        {messages.length === 0 && <p className="text-gray-400 text-center mt-10">Ask me to create a repo, list issues, or check file contents!</p>}
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[80%] p-3 rounded-lg ${m.role === 'user' ? 'bg-blue-600 text-white' : 'bg-white border shadow-sm'}`}>
                                    <p className="whitespace-pre-wrap">{m.content}</p>
                                </div>
                            </div>
                        ))}
                        {loading && <div className="text-gray-500 text-sm animate-pulse">Thinking...</div>}
                    </div>
                    <form onSubmit={sendMessage} className="flex gap-2">
                        <input 
                            className="flex-1 border p-2 rounded" 
                            placeholder="Type your instruction... (e.g. 'Create a private repo named test-agent')" 
                            value={input} 
                            onChange={e => setInput(e.target.value)} 
                            disabled={loading}
                        />
                        <button className="bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50">Send</button>
                    </form>
                </div>
            );
        }

        function GitHub({ token }) {
            const [repos, setRepos] = React.useState([]);
            const [repoName, setRepoName] = React.useState("");
            const [msg, setMsg] = React.useState("");
            const [isPrivate, setIsPrivate] = React.useState(false);
            
            // OAuth connection state
            const [connectionStatus, setConnectionStatus] = React.useState({ connected: false, username: null, loading: true });

            // Check connection status on mount and when URL has callback param
            React.useEffect(() => {
                checkConnectionStatus();
                
                // Handle OAuth callback
                const urlParams = new URLSearchParams(window.location.search);
                const callback = urlParams.get('callback');
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                
                if (callback === 'github' && code && state) {
                    handleGitHubCallback(code, state);
                }
            }, []);

            const handleGitHubCallback = async (code, state) => {
                setMsg("Finishing GitHub connection...");
                try {
                    await axios.post(`${API_URL}/github/callback`, 
                        { code, state },
                        { headers: { Authorization: `Bearer ${token}` } }
                    );
                    setMsg("GitHub connected successfully!");
                    // Clean up URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    checkConnectionStatus();
                } catch (err) {
                    setMsg("Failed to complete connection: " + (err.response?.data?.detail || err.message));
                }
            };

            const checkConnectionStatus = async () => {
                try {
                    const res = await axios.get(`${API_URL}/github/status`, { headers: { Authorization: `Bearer ${token}` } });
                    setConnectionStatus({ ...res.data, loading: false });
                    if (res.data.connected) {
                        fetchRepos();
                    }
                } catch (err) {
                    console.error(err);
                    setConnectionStatus({ connected: false, username: null, loading: false });
                }
            };

            const connectGitHub = async () => {
                try {
                    const res = await axios.get(`${API_URL}/github/connect`, { headers: { Authorization: `Bearer ${token}` } });
                    // Redirect to GitHub OAuth page
                    window.location.href = res.data.authorization_url;
                } catch (err) {
                    setMsg("Failed to initiate GitHub connection: " + (err.response?.data?.detail || err.message));
                }
            };

            const disconnectGitHub = async () => {
                try {
                    await axios.delete(`${API_URL}/github/disconnect`, { headers: { Authorization: `Bearer ${token}` } });
                    setConnectionStatus({ connected: false, username: null, loading: false });
                    setRepos([]);
                    setMsg("GitHub disconnected successfully");
                } catch (err) {
                    setMsg("Failed to disconnect: " + (err.response?.data?.detail || err.message));
                }
            };

            const fetchRepos = async () => {
                try {
                    const res = await axios.get(`${API_URL}/github/repos`, { headers: { Authorization: `Bearer ${token}` } });
                    setRepos(res.data);
                    setMsg("");
                } catch (err) {
                    console.error(err);
                    setMsg("Failed to fetch repos. Please reconnect your GitHub account.");
                }
            };
            
            const createRepo = async (e) => {
                e.preventDefault();
                try {
                    await axios.post(`${API_URL}/github/repos`, { name: repoName, private: isPrivate }, { headers: { Authorization: `Bearer ${token}` } });
                    setMsg("Repository created successfully!");
                    setRepoName("");
                    setIsPrivate(false);
                    fetchRepos();
                } catch (err) {
                    setMsg("Failed to create repo: " + (err.response?.data?.detail || err.message));
                }
            };

            if (connectionStatus.loading) {
                return <div className="text-center py-8 text-gray-500">Checking GitHub connection...</div>;
            }

            return (
                <div className="space-y-6">
                    {/* Connection Status Section */}
                    <div className="bg-gray-50 p-4 rounded border">
                        <h3 className="font-bold mb-3">GitHub Connection</h3>
                        {connectionStatus.connected ? (
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                                    <div>
                                        <p className="font-medium text-green-700">Connected</p>
                                        {connectionStatus.username && (
                                            <p className="text-sm text-gray-600">@{connectionStatus.username}</p>
                                        )}
                                    </div>
                                </div>
                                <button 
                                    onClick={disconnectGitHub} 
                                    className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm"
                                >
                                    Disconnect
                                </button>
                            </div>
                        ) : (
                            <div>
                                <p className="text-gray-600 mb-3">Connect your GitHub account to manage repositories</p>
                                <button 
                                    onClick={connectGitHub} 
                                    className="bg-gray-900 hover:bg-gray-800 text-white px-6 py-2 rounded flex items-center gap-2"
                                >
                                    <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                                    </svg>
                                    Connect GitHub
                                </button>
                                <p className="text-xs text-gray-500 mt-2">You'll be redirected to GitHub to authorize access</p>
                            </div>
                        )}
                    </div>

                    {/* Only show repo management if connected */}
                    {connectionStatus.connected && (
                        <>
                            <div className="bg-gray-50 p-4 rounded border">
                                <h3 className="font-bold mb-2">Create Repository</h3>
                                <form onSubmit={createRepo} className="space-y-3">
                                    <div className="flex gap-2">
                                        <input 
                                            className="border p-2 rounded flex-1" 
                                            placeholder="Repository Name" 
                                            value={repoName} 
                                            onChange={e => setRepoName(e.target.value)} 
                                            required 
                                        />
                                        <button type="submit" className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                            Create
                                        </button>
                                    </div>
                                    <label className="flex items-center gap-2 text-sm">
                                        <input 
                                            type="checkbox" 
                                            checked={isPrivate} 
                                            onChange={e => setIsPrivate(e.target.checked)}
                                            className="rounded"
                                        />
                                        Private repository
                                    </label>
                                </form>
                            </div>

                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="font-bold">Your Repositories</h3>
                                    <button onClick={fetchRepos} className="text-sm text-blue-500 hover:text-blue-700 underline">
                                        Refresh
                                    </button>
                                </div>
                                {repos.length === 0 ? (
                                    <p className="text-gray-500 italic">No repositories found. Create one above!</p>
                                ) : (
                                    <ul className="space-y-2">
                                        {repos.map(r => (
                                            <li key={r.id} className="flex justify-between items-center bg-white p-3 border rounded">
                                                <div>
                                                    <span className="font-medium">{r.name}</span>
                                                    <span className={`ml-2 text-xs px-2 py-1 rounded ${r.private ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                                                        {r.private ? 'Private' : 'Public'}
                                                    </span>
                                                </div>
                                                {r.html_url && (
                                                    <a href={r.html_url} target="_blank" rel="noopener noreferrer" className="text-blue-500 text-sm hover:underline">
                                                        View on GitHub
                                                    </a>
                                                )}
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                        </>
                    )}
                    
                    {msg && (
                        <p className={`p-3 rounded ${msg.includes('Failed') || msg.includes('error') ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                            {msg}
                        </p>
                    )}
                </div>
            );
        }

        function Figma({ token }) {
            const [fileKey, setFileKey] = React.useState("");
            const [data, setData] = React.useState(null);
            const [manualToken, setManualToken] = React.useState("");
            const [msg, setMsg] = React.useState("");

            const analyze = async (e) => {
                e.preventDefault();
                try {
                    const res = await axios.get(`${API_URL}/figma/analyze/${fileKey}`, { headers: { Authorization: `Bearer ${token}` } });
                    setData(res.data);
                    setMsg("");
                } catch (err) {
                    setMsg("Failed to analyze. Check token and file key.");
                }
            };

            const saveToken = async () => {
                try {
                    await axios.post(`${API_URL}/integrations/token`, { provider: "figma", token: manualToken }, { headers: { Authorization: `Bearer ${token}` } });
                    setMsg("Token saved!");
                    setManualToken("");
                } catch (err) { setMsg("Failed to save token"); }
            }

            return (
                <div className="space-y-6">
                    <div className="bg-gray-50 p-4 rounded border">
                         <h3 className="font-bold mb-2">1. Connect Figma</h3>
                         <div className="flex gap-2">
                            <input className="border p-1 rounded flex-1" placeholder="Paste Figma Access Token" value={manualToken} onChange={e => setManualToken(e.target.value)} />
                            <button onClick={saveToken} className="bg-green-600 text-white px-3 py-1 rounded">Save Token</button>
                         </div>
                    </div>

                    <form onSubmit={analyze} className="flex gap-2">
                        <input className="border p-2 rounded flex-1" placeholder="Figma File Key (from URL)" value={fileKey} onChange={e => setFileKey(e.target.value)} required />
                        <button className="bg-purple-600 text-white px-4 py-2 rounded">Fetch Layers</button>
                    </form>

                    {data && (
                        <div className="bg-gray-50 p-4 rounded border overflow-auto">
                            <h4 className="font-bold">{data.file_name}</h4>
                            <p className="text-sm text-gray-600 mb-2">{data.raw_data_summary}</p>
                            <pre className="text-xs bg-gray-200 p-2 rounded">{JSON.stringify(data.frames, null, 2)}</pre>
                        </div>
                    )}
                    {msg && <p className="text-red-500">{msg}</p>}
                </div>
            );
        }

        function Trello({ token }) {
            const [boards, setBoards] = React.useState([]);
            const [boardName, setBoardName] = React.useState("");
            const [manualToken, setManualToken] = React.useState("");
            const [msg, setMsg] = React.useState("");
            
            // New state for card creation
            const [selectedBoard, setSelectedBoard] = React.useState(null);
            const [lists, setLists] = React.useState([]);
            const [cardName, setCardName] = React.useState("");
            const [selectedListId, setSelectedListId] = React.useState("");

            const saveToken = async () => {
                try {
                    await axios.post(`${API_URL}/integrations/token`, { provider: "trello", token: manualToken }, { headers: { Authorization: `Bearer ${token}` } });
                    setMsg("Token saved!");
                    setManualToken("");
                } catch (err) { setMsg("Failed to save token"); }
            }

            const fetchBoards = async () => {
                try {
                    const res = await axios.get(`${API_URL}/trello/boards`, { headers: { Authorization: `Bearer ${token}` } });
                    setBoards(res.data);
                } catch (err) { setMsg("Failed to fetch boards"); }
            };

            const fetchLists = async (boardId) => {
                try {
                    const res = await axios.get(`${API_URL}/trello/boards/${boardId}/lists`, { headers: { Authorization: `Bearer ${token}` } });
                    setLists(res.data);
                    setSelectedBoard(boardId);
                    if (res.data.length > 0) setSelectedListId(res.data[0].id);
                } catch (err) { setMsg("Failed to fetch lists"); }
            };

            const createBoard = async (e) => {
                e.preventDefault();
                try {
                    await axios.post(`${API_URL}/trello/boards`, { name: boardName }, { headers: { Authorization: `Bearer ${token}` } });
                    setMsg("Board created!");
                    setBoardName("");
                    fetchBoards();
                } catch (err) { setMsg("Failed to create board"); }
            };

            const createCard = async (e) => {
                e.preventDefault();
                try {
                    await axios.post(`${API_URL}/trello/cards`, 
                        { list_id: selectedListId, name: cardName }, 
                        { headers: { Authorization: `Bearer ${token}` } }
                    );
                    setMsg("Card created!");
                    setCardName("");
                } catch (err) { setMsg("Failed to create card"); }
            };

            return (
                <div className="space-y-6">
                     <div className="bg-gray-50 p-4 rounded border">
                         <h3 className="font-bold mb-2">1. Connect Trello</h3>
                         <div className="flex gap-2">
                            <input className="border p-1 rounded flex-1" placeholder="Paste Trello Token" value={manualToken} onChange={e => setManualToken(e.target.value)} />
                            <button onClick={saveToken} className="bg-green-600 text-white px-3 py-1 rounded">Save Token</button>
                         </div>
                         <p className="text-xs text-gray-500 mt-1">Get token from Trello Developer Sandbox</p>
                    </div>

                    <div className="bg-gray-50 p-4 rounded border">
                        <h3 className="font-bold mb-2">2. Create Board</h3>
                        <form onSubmit={createBoard} className="flex gap-2">
                            <input className="border p-2 rounded flex-1" placeholder="New Board Name" value={boardName} onChange={e => setBoardName(e.target.value)} required />
                            <button className="bg-blue-500 text-white px-4 py-2 rounded">Create Board</button>
                        </form>
                    </div>

                    <div>
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="font-bold">Your Boards</h3>
                            <button onClick={fetchBoards} className="text-sm text-blue-500 underline">Refresh Boards</button>
                        </div>
                        <ul className="space-y-2">
                            {boards.map(b => (
                                <li key={b.id} className="flex justify-between items-center bg-white p-2 border rounded">
                                    <span>{b.name}</span>
                                    <button onClick={() => fetchLists(b.id)} className="bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-sm">
                                        Select / Get Lists
                                    </button>
                                </li>
                            ))}
                        </ul>
                    </div>

                    {selectedBoard && (
                        <div className="bg-gray-50 p-4 rounded border border-blue-200">
                             <h3 className="font-bold mb-2">3. Create Card</h3>
                             {lists.length === 0 ? <p>No lists found on this board.</p> : (
                                 <form onSubmit={createCard} className="space-y-2">
                                     <div>
                                         <label className="text-xs font-bold block">Select List</label>
                                         <select className="w-full border p-2 rounded" value={selectedListId} onChange={e => setSelectedListId(e.target.value)}>
                                             {lists.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
                                         </select>
                                     </div>
                                     <div>
                                         <label className="text-xs font-bold block">Card Name</label>
                                         <input className="w-full border p-2 rounded" placeholder="New Card Title" value={cardName} onChange={e => setCardName(e.target.value)} required />
                                     </div>
                                     <button className="bg-green-600 text-white px-4 py-2 rounded w-full">Create Card</button>
                                 </form>
                             )}
                        </div>
                    )}

                    {msg && <p className="text-blue-600 font-bold">{msg}</p>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

